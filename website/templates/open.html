<!DOCTYPE html>
<html>
<head>
    <title>Preguntas Abiertas</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="shortcut icon" href="static/img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../static/css/style.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <link rel="canonical" href="http://digital.psico.edu.uy/cannabis">

</head>
<body>
    <h1>Preguntas Abiertas</h1>
    <main>
    <p>A continuación, se te presentan 3 preguntas abiertas. Estando tranquilo/a y ubicado/a en un lugar cómodo, responde libremente a cada una de ellas grabando y enviando una nota de voz desde tu celular.</p>

        <!-- Question 1 -->
    <p>1. Relata con el mayor detalle posible cómo es para ti un día común y corriente.</p>
    <button id="recordButton1" onclick="startRecording(1)" class="recordButton">Grabar Respuesta</button>
    <button id="stopButton1" onclick="stopRecording(1)" class="stopButton" disabled>Detener Grabación</button>
    <input type="file" accept="audio/*" id="audioUpload1" style="display:none;"><div id="tick1" style="visibility:hidden"><img src="static/img/tick.png" style="width:30px;height:30px"></div>
    <br>

    <!-- Question 3 -->
    <p>3. Relata cómo le explicarías a una persona sorda qué es escuchar</p>
    <button id="recordButton2" onclick="startRecording(2)" class="recordButton">Grabar Respuesta</button>
    <button id="stopButton2" onclick="stopRecording(2)" class="stopButton" disabled>Detener Grabación</button>
    <br>
    <input type="file" accept="audio/*" id="audioUpload3" style="display:none;"><div id="tick2" style="visibility:hidden"><img src="static/img/tick.png" style="width:30px;height:30px"></div>
    
</p>

    <button onclick="submitAnswers()" disabled id="enviar">Enviar Respuestas</button>

</p> 

 
    
<script src="https://cdn.WebRTC-Experiment.com/RecordRTC.js"></script>
<script>
    let recorders = {};
    let audioBlobs = {};
    function startRecording(questionNumber) {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            const recorder = new RecordRTC(stream, { type: 'audio', timeSlice: 180000 });
            recorders[questionNumber] = recorder;
            recorder.startRecording();
            audios[questionNumber-1]=false;
            //document.getElementById('recordButton' + questionNumber).disabled = true;
            //document.getElementsByClassName("recordButton").disabled=true; // disable all recording buttons
            const collection = document.getElementsByClassName("recordButton");
            for (let i = 0; i < collection.length; i++) {
                collection[i].disabled = true;
            }
            document.getElementById('stopButton' + questionNumber).disabled = false;
            document.getElementById('enviar').disabled = true;
            document.getElementById('tick' + questionNumber).style.visibility = 'hidden';

            // Automatically stop recording after 3 minutes
            setTimeout(() => {
                stopRecording(questionNumber);
            }, 180000);
        }).catch(e => {
            console.error('Error al comenzar la grabación: ', e);
        });
    }

    function stopRecording(questionNumber) {
        let recorder = recorders[questionNumber];
        if (recorder) {
            recorder.stopRecording(() => {
                let blob = recorder.getBlob();
                audioBlobs[questionNumber] = blob;
                
                // Reset buttons
                //document.getElementsByClassName("recordButton").disabled = false; // disable all recording buttons
                const collection = document.getElementsByClassName("recordButton");
                for (let i = 0; i < collection.length; i++) {
                    collection[i].disabled = false;
                }
                document.getElementById('stopButton' + questionNumber).disabled = true;
                document.getElementById('tick' + questionNumber).style.visibility = 'visible';
                audios[questionNumber-1]=true;
                if (audios[0] && audios[1]) {
                    document.getElementById('enviar').disabled = false;
                }
            });
        }
    }

   function submitAnswers() {
        let formData = new FormData();

        // Assuming audioBlobs is an object containing the audio data
        Object.keys(audioBlobs).forEach(questionNumber => {
            // Append each audio blob to formData with a key
            formData.append('audio' + questionNumber, audioBlobs[questionNumber], 'question' + questionNumber + '.wav');
        });

        fetch('/upload-audio', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // If the upload was successful, you might redirect the user or display a success message
                alert("Audios enviados correctamente!!");
                window.location.href = '/gracias'; // Redirect to another page if needed
            } else {
                // If the server responded with an error, display it
                alert("Error: " + data.error);
            }
        })
        .catch(error => {
            // Handle any errors that occurred during fetch
            console.error('Error:', error);
            alert("Ocurrió un error durante el envío, por favor vuelva a intentarlo en unos segundos...: " + error.message);
    });
}

let audios = [false,false];

</script>

    
    
    <main>
</body>
</html>
